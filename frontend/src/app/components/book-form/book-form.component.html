<!-- Compact Modal-Style Form -->
<div class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4 z-50">
  <div class="bg-base-100 rounded-2xl shadow-2xl w-full max-w-xl max-h-[98vh] overflow-hidden flex flex-col">
    <!-- Minimal Header -->
    <div class="flex items-center justify-between px-5 py-3 border-b border-base-300">
      <h2 class="text-lg font-bold">{{ isEditMode ? 'Edit' : 'Add' }} Book</h2>
      <button class="btn btn-ghost btn-circle btn-xs" routerLink="/books">
        <ng-icon name="heroXMark" size="1rem"></ng-icon>
      </button>
    </div>

    <!-- Form Content -->
    <form [formGroup]="bookForm" (ngSubmit)="onSubmit()" class="flex-1 overflow-y-auto">
      <div class="p-5 pb-8 space-y-3">
        <div class="grid grid-cols-12 gap-6">
          <!-- Compact Image Upload -->
          <div class="col-span-5">
            <div class="aspect-[2/3] w-full min-w-[140px]">
              <!-- Dropzone -->
              <ngx-dropzone
                *ngIf="!imagePreviewUrl"
                (change)="onFilesAdded($event.addedFiles)"
                [multiple]="false"
                [accept]="'image/*'"
                class="!h-full !w-full !border-2 !border-dashed !border-base-300 hover:!border-primary !rounded-lg !bg-base-200 hover:!bg-base-300 transition-all cursor-pointer flex items-center justify-center"
              >
                <ngx-dropzone-label>
                  <div class="flex flex-col items-center justify-center p-2">
                    <ng-icon name="heroPhoto" size="2rem" class="text-base-content/30 mb-1"></ng-icon>
                    <p class="text-xs text-base-content/50 text-center">Drop or click</p>
                  </div>
                </ngx-dropzone-label>
              </ngx-dropzone>

              <!-- Image Preview -->
              <div *ngIf="imagePreviewUrl" class="relative group h-full w-full">
                <div class="h-full w-full rounded-lg overflow-hidden bg-base-300 border-2 border-base-300">
                  <img [src]="imagePreviewUrl" alt="Cover" class="w-full h-full object-cover" />
                </div>
                <button
                  type="button"
                  (click)="onFileRemoved()"
                  class="absolute -top-1 -right-1 btn btn-circle btn-xs bg-error hover:bg-error/90 text-white border-0 opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  <ng-icon name="heroXMark" size="0.75rem"></ng-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Form Fields -->
          <div class="col-span-7 pl-6">
            <!-- Title -->
            <div class="form-control">
              <label class="label py-0 pb-0.5">
                <span class="label-text text-xs font-medium">Title <span class="text-error">*</span></span>
              </label>
              <input
                type="text"
                formControlName="title"
                class="input input-sm input-bordered w-full"
                placeholder="Book title"
                [class.input-error]="bookForm.get('title')?.invalid && bookForm.get('title')?.touched"
              />
            </div>

            <!-- Author -->
            <div class="form-control">
              <label class="label py-0 pb-0.5">
                <span class="label-text text-xs font-medium">Author <span class="text-error">*</span></span>
              </label>
              <ng-select
                [items]="authors"
                bindLabel="name"
                bindValue="id"
                formControlName="authorId"
                placeholder="Select author"
                [clearable]="true"
                [searchable]="true"
                class="ng-select-sm"
                [class.ng-select-error]="bookForm.get('authorId')?.invalid && bookForm.get('authorId')?.touched"
              >
                <ng-template ng-label-tmp let-item="item">
                  <div class="flex items-center gap-1.5">
                    <div *ngIf="getSelectedAuthorImage(item.id)" class="w-5 h-5 rounded-full overflow-hidden border border-base-300">
                      <img [src]="getSelectedAuthorImage(item.id)" [alt]="item.name" class="w-full h-full object-cover" />
                    </div>
                    <div *ngIf="!getSelectedAuthorImage(item.id)" class="avatar placeholder">
                      <div class="w-5 h-5 rounded-full bg-primary text-primary-content">
                        <span class="text-[10px]">{{ item.name.charAt(0) }}</span>
                      </div>
                    </div>
                    <span class="text-sm">{{ item.name }}</span>
                  </div>
                </ng-template>
                <ng-template ng-option-tmp let-item="item">
                  <div class="flex items-center gap-2 py-0.5">
                    <div *ngIf="item.imageUrl" class="w-6 h-6 rounded-full overflow-hidden border border-base-300">
                      <img [src]="getRootUrl() + item.imageUrl" [alt]="item.name" class="w-full h-full object-cover" />
                    </div>
                    <div *ngIf="!item.imageUrl" class="avatar placeholder">
                      <div class="w-6 h-6 rounded-full bg-primary text-primary-content">
                        <span class="text-[10px]">{{ item.name.charAt(0) }}</span>
                      </div>
                    </div>
                    <span class="text-sm">{{ item.name }}</span>
                  </div>
                </ng-template>
              </ng-select>
            </div>

            <!-- Total Pages -->
            <div class="form-control">
              <label class="label py-0 pb-0.5">
                <span class="label-text text-xs font-medium">Pages <span class="text-error">*</span></span>
              </label>
              <input
                type="number"
                formControlName="totalPages"
                class="input input-sm input-bordered w-full"
                placeholder="e.g., 320"
                min="1"
                [class.input-error]="bookForm.get('totalPages')?.invalid && bookForm.get('totalPages')?.touched"
              />
            </div>

            <!-- Tags -->
            <div class="form-control">
              <label class="label py-0 pb-0.5">
                <span class="label-text text-xs font-medium">Tags</span>
              </label>
              <ng-select
                [items]="tags"
                bindLabel="name"
                bindValue="id"
                [multiple]="true"
                [(ngModel)]="selectedTags"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onTagsChange($event)"
                placeholder="Select tags"
                [clearable]="true"
                [searchable]="true"
                class="ng-select-sm"
              >
                <ng-template ng-multi-label-tmp let-items="items" let-clear="clear">
                  <div class="flex flex-wrap gap-1">
                    <div *ngFor="let item of items" class="badge badge-primary badge-xs gap-0.5 px-1.5 py-0.5">
                      <span class="text-[10px]">{{ item.name }}</span>
                      <button type="button" (click)="clear(item)" class="hover:text-error">
                        <ng-icon name="heroXMark" size="0.625rem"></ng-icon>
                      </button>
                    </div>
                  </div>
                </ng-template>
                <ng-template ng-option-tmp let-item="item">
                  <span class="badge badge-primary badge-xs text-[10px]">{{ item.name }}</span>
                </ng-template>
              </ng-select>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- Compact Footer -->
    <div class="flex items-center justify-end gap-2 px-5 py-3 border-t border-base-300 bg-base-200/50">
      <button type="button" routerLink="/books" class="btn btn-ghost btn-sm">Cancel</button>
      <button
        type="submit"
        (click)="onSubmit()"
        class="btn btn-primary btn-sm px-4"
        [disabled]="bookForm.invalid || isLoading"
      >
        <span *ngIf="isLoading" class="loading loading-spinner loading-xs"></span>
        <span *ngIf="!isLoading">{{ isEditMode ? 'Update' : 'Add' }}</span>
      </button>
    </div>
  </div>
</div>
